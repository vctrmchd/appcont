<script>
  var currentUser = null;
  var allClientes = [];

  // Inicialização
  document.addEventListener("DOMContentLoaded", function() {
    M.AutoInit(); // Inicializa todos os componentes do Materialize
    loadUser();
    showDashboard();
  });

  // Função genérica para lidar com erros do Apps Script
  function handleBackendError(error) {
    console.error("Erro do Backend:", error.message);
    M.toast({html: error.message || "Ocorreu um erro inesperado.", classes: "red"});
  }

  function loadUser() {
    google.script.run
      .withSuccessHandler(function(user) {
        currentUser = user;
        document.getElementById("userEmailDisplay").textContent = user.email + " (" + user.papel + ")";
        // Esconder seções que o usuário não tem permissão
        if (user.papel !== "Administrador") {
          document.getElementById("usuariosSection").classList.add("hidden");
          document.querySelector("a[onclick=\"showUsuarios()\"]").parentElement.classList.add("hidden");
          document.getElementById("auditoriaSection").classList.add("hidden");
          document.querySelector("a[onclick=\"showAuditoria()\"]").parentElement.classList.add("hidden");
        }
      })
      .withFailureHandler(handleBackendError)
      .getLoggedUser();
  }

  function showDashboard() {
    hideAllSections();
    document.getElementById("dashboardSection").classList.remove("hidden");
    loadDashboardStats();
  }

  function showClientes() {
    hideAllSections();
    document.getElementById("clientesSection").classList.remove("hidden");
    loadClientes();
  }

  function showUsuarios() {
    if (currentUser && currentUser.papel === "Administrador") {
      hideAllSections();
      document.getElementById("usuariosSection").classList.remove("hidden");
      loadUsuarios();
    } else {
      M.toast({html: "Você não tem permissão para acessar esta seção.", classes: "red"});
    }
  }

  function showAuditoria() {
    if (currentUser && currentUser.papel === "Administrador") {
      hideAllSections();
      document.getElementById("auditoriaSection").classList.remove("hidden");
      loadAuditoria();
    } else {
      M.toast({html: "Você não tem permissão para acessar esta seção.", classes: "red"});
    }
  }

  function hideAllSections() {
    document.getElementById("dashboardSection").classList.add("hidden");
    document.getElementById("clientesSection").classList.add("hidden");
    document.getElementById("usuariosSection").classList.add("hidden");
    document.getElementById("auditoriaSection").classList.add("hidden");
  }

  function loadDashboardStats() {
    google.script.run
      .withSuccessHandler(function(stats) {
        document.getElementById("totalClientes").textContent = stats.totalClientes;
        document.getElementById("clientesAtivos").textContent = stats.clientesPorSituacao.Ativo || 0;
        document.getElementById("clientesVencimento").textContent = stats.clientesVencimentoProximo;
        document.getElementById("clientesPendencia").textContent = stats.clientesComPendenciaFiscal;

        // Clientes por Empresa
        var empresaHtml = '<ul class="collection">';
        for (var empresa in stats.clientesPorEmpresa) {
          empresaHtml += '<li class="collection-item"><strong>' + empresa + ':</strong> ' + stats.clientesPorEmpresa[empresa] + '</li>';
        }
        empresaHtml += '</ul>';
        document.getElementById('clientesPorEmpresa').innerHTML = empresaHtml;

        // Clientes por Tributação
        var tributacaoHtml = '<ul class="collection">';
        for (var tributacao in stats.clientesPorTributacao) {
          tributacaoHtml += '<li class="collection-item"><strong>' + tributacao + ':</strong> ' + stats.clientesPorTributacao[tributacao] + '</li>';
        }
        tributacaoHtml += '</ul>';
        document.getElementById('clientesPorTributacao').innerHTML = tributacaoHtml;
      })
      .withFailureHandler(handleBackendError)
      .getDashboardStats();
  }

  function loadClientes() {
    google.script.run
      .withSuccessHandler(function(clientes) {
        allClientes = clientes;
        renderClientes(clientes);
      })
      .withFailureHandler(handleBackendError)
      .getClientes();
  }

  function renderClientes(clientes) {
    var tbody = document.getElementById('clientesTableBody');
    tbody.innerHTML = '';
    clientes.forEach(function(cliente) {
      var row = tbody.insertRow();
      row.className = 'cliente-row';
      row.innerHTML = '<td>' + cliente.id_cliente + '</td>' +
                      '<td>' + cliente.razao_social + '</td>' +
                      '<td>' + cliente.cpf_cnpj + '</td>' +
                      '<td>' + cliente.municipio + '</td>' +
                      '<td>' + cliente.situacao + '</td>' +
                      '<td>' + cliente.empresa_responsavel + '</td>' +
                      '<td>' +
                      '<a href="#!" class="btn-small waves-effect waves-light blue" onclick="viewCliente(' + cliente.id_cliente + ')"><i class="material-icons">visibility</i></a> ' +
                      '<a href="#!" class="btn-small waves-effect waves-light green" onclick="editCliente(' + cliente.id_cliente + ')"><i class="material-icons">edit</i></a> ' +
                      '<a href="#!" class="btn-small waves-effect waves-light red" onclick="deleteCliente(' + cliente.id_cliente + ')"><i class="material-icons">delete</i></a>' +
                      '<a href="#!" class="btn-small waves-effect waves-light orange" onclick="abrirSenhaModal(' + cliente.id_cliente + ', \u0027Serviço Exemplo\u0027)"><i class="material-icons">vpn_key</i></a>' +
                      '</td>';
    });
  }

  function filterClientes() {
    var searchTerm = document.getElementById('searchCliente').value.toLowerCase();
    var filteredClientes = allClientes.filter(function(cliente) {
      return cliente.razao_social.toLowerCase().includes(searchTerm) || cliente.cpf_cnpj.toLowerCase().includes(searchTerm);
    });
    renderClientes(filteredClientes);
  }

  function viewCliente(id_cliente) {
    google.script.run
      .withSuccessHandler(function(cliente) {
        if (cliente) {
          alert('Detalhes do Cliente:\n\nRazão Social: ' + cliente.razao_social + '\nCPF/CNPJ: ' + cliente.cpf_cnpj + '\nMunicípio: ' + cliente.municipio + '\nSituação: ' + cliente.situacao);
        } else {
          M.toast({html: 'Cliente não encontrado!', classes: 'red'});
        }
      })
      .withFailureHandler(handleBackendError)
      .getClienteById(id_cliente);
  }

  function editCliente(id_cliente) {
    M.toast({html: 'Funcionalidade de edição em desenvolvimento.', classes: 'blue'});
    // Aqui você abriria um modal ou navegaria para uma página de edição
  }

  function deleteCliente(id_cliente) {
    if (confirm('Tem certeza que deseja deletar este cliente?')) {
      google.script.run
        .withSuccessHandler(function(success) {
          if (success) {
            M.toast({html: 'Cliente deletado com sucesso!', classes: 'green'});
            loadClientes();
          } else {
            M.toast({html: 'Erro ao deletar cliente.', classes: 'red'});
          }
        })
        .withFailureHandler(handleBackendError)
        .deleteCliente(id_cliente);
    }
  }

  function openNovoClienteModal() {
    M.toast({html: 'Funcionalidade de criação de cliente em desenvolvimento.', classes: 'blue'});
    // Aqui você abriria um modal para adicionar um novo cliente
  }

  function loadUsuarios() {
    google.script.run
      .withSuccessHandler(function(usuarios) {
        var tbody = document.getElementById('usuariosTableBody');
        tbody.innerHTML = '';
        usuarios.forEach(function(usuario) {
          var row = tbody.insertRow();
          row.innerHTML = '<td>' + usuario.email + '</td>' +
                          '<td>' + usuario.nome + '</td>' +
                          '<td>' + usuario.empresa + '</td>' +
                          '<td>' + usuario.papel + '</td>' +
                          '<td>' + (usuario.ativo ? 'Sim' : 'Não') + '</td>' +
                          '<td>' +
                          '<a href="#!" class="btn-small waves-effect waves-light green" onclick="editUsuario(\'' + usuario.email + '\')"><i class="material-icons">edit</i></a> ' +
                          '<a href="#!" class="btn-small waves-effect waves-light red" onclick="deleteUsuario(\'' + usuario.email + '\')"><i class="material-icons">delete</i></a>' +
                          '</td>';
        });
      })
      .withFailureHandler(handleBackendError)
      .getUsuarios();
  }

  function editUsuario(email) {
    M.toast({html: 'Funcionalidade de edição de usuário em desenvolvimento.', classes: 'blue'});
    // Aqui você abriria um modal ou navegaria para uma página de edição de usuário
  }

  function deleteUsuario(email) {
    if (confirm('Tem certeza que deseja deletar este usuário?')) {
      google.script.run
        .withSuccessHandler(function(success) {
          if (success) {
            M.toast({html: 'Usuário deletado com sucesso!', classes: 'green'});
            loadUsuarios();
          } else {
            M.toast({html: 'Erro ao deletar usuário.', classes: 'red'});
          }
        })
        .withFailureHandler(handleBackendError)
        .deleteUsuario(email);
    }
  }

  function openNovoUsuarioModal() {
    M.toast({html: 'Funcionalidade de criação de usuário em desenvolvimento.', classes: 'blue'});
    // Aqui você abriria um modal para adicionar um novo usuário
  }

  function loadAuditoria() {
    google.script.run
      .withSuccessHandler(function(logs) {
        var tbody = document.getElementById('auditoriaTableBody');
        tbody.innerHTML = '';
        logs.forEach(function(log) {
          var row = tbody.insertRow();
          row.innerHTML = '<td>' + new Date(log.timestamp).toLocaleString() + '</td>' +
                          '<td>' + log.email_usuario + '</td>' +
                          '<td>' + log.acao + '</td>' +
                          '<td>' + (log.id_cliente_afetado || '-') + '</td>' +
                          '<td>' + log.detalhes + '</td>';
        });
      })
      .withFailureHandler(handleBackendError)
      .getAuditoriaLogs(); // Esta função precisa ser criada no AuditoriaController.gs
  }

  function abrirSenhaModal(id_cliente, servico) {
    google.script.run
      .withSuccessHandler(function(senhaDescriptografada) {
        if (senhaDescriptografada) {
          document.getElementById('senhaServico').textContent = servico;
          document.getElementById('senhaDisplay').value = senhaDescriptografada;
          var modal = M.Modal.getInstance(document.getElementById('senhaModal'));
          modal.open();
        } else {
          M.toast({html: 'Senha não encontrada ou você não tem permissão!', classes: 'red'});
        }
      })
      .withFailureHandler(handleBackendError)
      .getSenhaCopiada(id_cliente, servico);
  }

  function copiarSenha() {
    var senhaField = document.getElementById('senhaDisplay');
    senhaField.select();
    senhaField.setSelectionRange(0, 99999); // Para dispositivos móveis
    document.execCommand('copy');
    M.toast({html: 'Senha copiada para a área de transferência!', classes: 'green'});
  }
</script>

